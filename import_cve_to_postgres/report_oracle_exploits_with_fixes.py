import psycopg2
import csv
from dotenv import load_dotenv
import os

# Load environment variables from .env file
load_dotenv()

def get_connection():
    return psycopg2.connect(
        host="localhost",
        port="5432",
        dbname="mydatabase",
        user="myuser",
        password="mypassword"
    )

def generate_report(csv_path):
    conn = get_connection()
    query = '''
        SELECT cs.cve_id, cs.affected_package, cs.score
        FROM cve_simple cs
        JOIN cve_exploit_status ces ON cs.cve_id = ces.cve_id
        JOIN cve_fix_status cfs ON cs.cve_id = cfs.cve_id
        JOIN vendors v ON cs.cve_id = v.cve_id
        WHERE v.vendor_name ILIKE '%oracle%'
          AND ces.has_active_exploit = TRUE
          AND cfs.has_fix = TRUE
    '''
    with conn.cursor() as cur:
        cur.execute(query)
        rows = cur.fetchall()
    conn.close()
    # Write to CSV
    with open(csv_path, 'w', newline='', encoding='utf-8') as csvfile:
        writer = csv.writer(csvfile)
        writer.writerow(['cve_id', 'affected_package', 'score'])
        for row in rows:
            writer.writerow(row)
    print(f"Report saved to {csv_path}")

if __name__ == "__main__":
    output_csv = os.path.join(os.path.dirname(__file__), 'oracle_exploits_with_fixes.csv')
    generate_report(output_csv)
